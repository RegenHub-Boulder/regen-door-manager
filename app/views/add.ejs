<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add New User</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <!-- Centered logo -->
  <div class="logo-container">
    <img src="/images/regenhub_logo.png" alt="Logo">
  </div>

  <!-- Page content wrapped in a container with margins -->
  <div class="content-container">
    <h1>Add New User</h1>

    <div class="form-container">
      <form action="/add" method="POST" onsubmit="showSpinner()">
        <div class="form-group">
          <label for="name">Name:</label>
          <input type="text" id="name" name="name" required>
        </div>

        <div class="form-group">
          <label for="member_type">Member Type:</label>
          <select id="member_type" name="member_type" onchange="toggleMemberTypeFields()">
            <option value="full">Full Member</option>
            <option value="daypass">Day Pass Member</option>
          </select>
        </div>

        <div class="form-group">
          <label for="telegram_username">Telegram Username:</label>
          <input type="text" id="telegram_username" name="telegram_username" placeholder="@username">
          <small>Required for Telegram bot access</small>
        </div>

        <div class="form-group">
          <label for="email">Email:</label>
          <input type="email" id="email" name="email" placeholder="Enter Email">
        </div>

        <div class="form-group">
          <label for="ethereum_address">User Ethereum Address:</label>
          <input type="text" id="ethereum_address" name="ethereum_address" placeholder="0x...">
        </div>

        <div id="full-member-fields">
          <div class="form-group">
            <label for="pin_code_slot">Pin Code Slot:</label>
            <input type="number" id="pin_code_slot" name="pin_code_slot" value="<%= slot %>">
          </div>

          <div class="form-group">
            <label for="pin_code">Pin Code:</label>
            <div class="input-group">
              <input type="password" id="pin_code" name="pin_code">
              <button type="button" class="btn" onclick="generateRandomPin()">Generate Random PIN</button>
              <button type="button" class="btn" onclick="togglePinVisibility()">Show PIN</button>
            </div>
          </div>

          <div class="form-group">
            <label for="nfc_key_address">NFC Key Address:</label>
            <div class="input-group">
              <input type="text" id="nfc_key_address" name="nfc_key_address" readonly class="readonly-field">
              <button type="button" class="btn btn-get-nfc" onclick="fetchNfcKeyAddress()">Get NFC Key Address</button>
            </div>
          </div>
        </div>

        <div id="daypass-member-fields" style="display: none;">
          <div class="form-group">
            <label for="initial_passes">Initial Day Passes:</label>
            <input type="number" id="initial_passes" name="initial_passes" value="10" min="0">
            <small>Number of day passes to grant initially</small>
          </div>
        </div>

        <div id="statusText" class="status-text"></div>
        <div class="qr-container">
          <img id="qr" src="" alt="QR Code" style="display:none;">
        </div>

        <button type="submit" class="btn btn-submit">Submit</button>
        <div class="spinner" id="spinner"></div>

        <div id="error-messages" style="color: red;">
          <% if (typeof errorMessage !== 'undefined') { %>
            <p><%= errorMessage %></p>
          <% } %>
        </div>
      </form>

      <a href="/admin" class="back-link">Back to Admin</a>
    </div>
  </div>

  <script src="https://github.com/arx-research/libhalo/releases/download/libhalo-v1.8.5/libhalo.js"></script>
  <script src="/scripts/common.js"></script>
  <script>
    function toggleMemberTypeFields() {
      const memberType = document.getElementById('member_type').value;
      const fullFields = document.getElementById('full-member-fields');
      const daypassFields = document.getElementById('daypass-member-fields');

      if (memberType === 'full') {
        fullFields.style.display = 'block';
        daypassFields.style.display = 'none';
      } else {
        fullFields.style.display = 'none';
        daypassFields.style.display = 'block';
      }
    }

    document.querySelector('form').addEventListener('submit', function(event) {
      const memberType = document.getElementById('member_type').value;
      const telegramUsername = document.getElementById('telegram_username').value;
      const ethereumAddress = document.getElementById('ethereum_address').value;

      // Validate telegram username format if provided
      if (telegramUsername && !/^@[a-zA-Z0-9_]{5,32}$/.test(telegramUsername)) {
        event.preventDefault();
        alert('Telegram username must start with @ and be 5-32 characters.');
        return;
      }

      if (memberType === 'full') {
        const pinCodeSlot = document.getElementById('pin_code_slot').value;
        const pinCode = document.getElementById('pin_code').value;

        if (pinCodeSlot >= 250) {
          event.preventDefault();
          alert('Pin Code Slot must be less than 250.');
          return;
        }

        const pinCodePattern = /^\d{4,10}$/;
        if (pinCode && !pinCodePattern.test(pinCode)) {
          event.preventDefault();
          alert('Pin Code must be a number between 4 and 10 digits.');
          return;
        }
      }

      const ethAddressPattern = /^0x[a-fA-F0-9]{40}$/;
      if (ethereumAddress && !ethAddressPattern.test(ethereumAddress)) {
        event.preventDefault();
        alert('Invalid Ethereum Address.');
      }
    });
  </script>
</body>
</html>
